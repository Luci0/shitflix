FROM node:20-alpine AS dashboard-builder

WORKDIR /build
COPY ./dashboard/package.json ./dashboard/package-lock.json* ./
RUN npm ci

COPY ./dashboard/ ./
RUN npm run build || true

FROM alpine:3.20

RUN addgroup -g 1000 shitflix && \
    adduser -u 1000 -G shitflix -D shitflix && \
    apk add --no-cache tzdata transmission-cli=4.0.5-r2 transmission-daemon=4.0.5-r2 \
      transmission-remote=4.0.5-r2 curl jq cronie su-exec coreutils nodejs && \
    mkdir -p /downloads /config /shitflix /dashboard && \
    chown -R shitflix:shitflix /downloads /config /shitflix /dashboard && \
    chmod -R 775 /downloads /config /shitflix /dashboard

COPY --from=dashboard-builder --chown=shitflix:shitflix /build /dashboard

COPY ./scripts /shitflix/scripts
RUN chmod +x /shitflix/scripts/entrypoint.sh && \
    mkdir -p /shitflix/scripts/txts && \
    touch /shitflix/scripts/txts/wishlist.txt && \
    touch /shitflix/scripts/txts/banlist.txt && \
    chown -R shitflix:shitflix /shitflix/scripts && \
    chmod -R 755 /shitflix/scripts && \
    chmod 664 /shitflix/scripts/txts/wishlist.txt && \
    chmod 664 /shitflix/scripts/txts/banlist.txt

# Set a default cron schedule
ENV RUNNER_CRON_SCHEDULE="0 3 * * *"

EXPOSE 9091 7069

VOLUME ["/downloads", "/config", "/shitflix"]

# The entrypoint will run as root to set up cron, then switch to the 'shitflix' user.
ENTRYPOINT ["/shitflix/scripts/entrypoint.sh"]
