<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shitflix Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/icons/favicon.png">
    <script src="https://unpkg.com/htmx.org"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <h1>
        <img src="/icons/favicon.png" alt="Downloader icon"
             style="height: 1.2em;
             vertical-align: middle;
             margin-right: 0.2em;">
        Downloader
    </h1>

    <div class="service-buttons">
        <button onclick="window.open('http://localhost:8096', '_blank')" class="service-btn jellyfin-btn">
            🎬 Jellyfin
        </button>
        <button onclick="window.open('http://localhost:9091', '_blank')" class="service-btn transmission-btn">
            ⚙️ Transmission
        </button>
        <button id="wishlist-btn" class="service-btn wishlist-btn">
            📝 Wishlist
        </button>
    </div>

    <div class="search-form">
        <form onsubmit="return false;">
            <div class="form-group">
                <label for="movie">Movie Name</label>
                <input type="text" id="movie" name="movie" placeholder="Enter movie name..."/>
            </div>

            <div class="form-group">
                <label for="extra">Extra Search Params</label>
                <input type="text" id="extra" name="extra" value="1080" placeholder="Quality, year, etc..."/>
            </div>

            <button class="search-btn"
                    hx-get="/get-search-results"
                    hx-trigger="click"
                    hx-vals="{}"
                    hx-swap="innerHTML"
                    hx-target="#search-results-container"
                    hx-indicator=".loading"
                    onclick="setVals()">
                🔍 Search
            </button>
        </form>
    </div>

    <div id="download-result-container"></div>

    <div class="loading" style="display:none;">
        ⏳ Searching...
    </div>

    <div id="search-results-container">
        <!-- Results will be displayed here -->
    </div>
</div>

<div id="preloader-modal" class="modal">
    <div class="modal-content">
        <div class="modal-icon"></div>
    </div>
</div>

<div id="download-modal" class="modal">
    <div class="modal-content-dld">
        <div class="modal-form">
            <label for="download-location">Download Location:</label>
            <input type="text" id="download-location" value="/downloads/movies"/>
            <button id="confirm-download" class="confirm-btn">Start Download</button>
            <button id="cancel-download" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>
<div id="wishlist-modal" class="modal">
    <div class="wishlist-modal-content">
        <div class="wishlist-header">
            <h2>📝 Movie Wishlist</h2>
            <button class="close-wishlist-btn">&times;</button>
        </div>
        <div class="wishlist-body">
            <div id="wishlist-content"></div>
        </div>
    </div>
</div>
<script>
    // Auto-replace spaces with dots as user types
    document.getElementById('movie').addEventListener('input', function (e) {
        const cursorPosition = e.target.selectionStart;
        const originalValue = e.target.value;
        const newValue = originalValue.replace(/\s+/g, '.');

        if (originalValue !== newValue) {
            e.target.value = newValue;
            // Maintain cursor position after replacement
            const newCursorPosition = cursorPosition - (originalValue.length - newValue.length);
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        }
    });

    document.getElementById('extra').addEventListener('input', function (e) {
        const cursorPosition = e.target.selectionStart;
        const originalValue = e.target.value;
        const newValue = originalValue.replace(/\s+/g, '.');

        if (originalValue !== newValue) {
            e.target.value = newValue;
            // Maintain cursor position after replacement
            const newCursorPosition = cursorPosition - (originalValue.length - newValue.length);
            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
        }
    });

    function setVals() {
        const movie = document.getElementById('movie').value;
        const extra = document.getElementById('extra').value;

        const button = document.querySelector('button[hx-vals]');
        button.setAttribute('hx-vals', JSON.stringify({
            movie: movie,
            extra: extra
        }));

        // Clear download message when starting new search
        document.getElementById('download-result-container').innerHTML = '';
    }

    let modalShowTime = 0;
    let pendingDownload = null;

    // Use event delegation to catch dynamically added buttons
    document.body.addEventListener('click', function (evt) {
        if (evt.target.classList.contains('download-btn')) {
            evt.preventDefault();
            evt.stopPropagation();

            // Store the download info from data attributes
            pendingDownload = {
                name: decodeURIComponent(evt.target.dataset.name),
                link: decodeURIComponent(evt.target.dataset.link)
            };

            // Show modal
            document.getElementById('download-modal').classList.add('show');
        }
    });

    // Handle confirm download
    document.getElementById('confirm-download').addEventListener('click', function () {
        if (pendingDownload) {
            const downloadLocation = document.getElementById('download-location').value;
            const downloadUrl = `/download-torrent?name=${encodeURIComponent(pendingDownload.name)}&link=${encodeURIComponent(pendingDownload.link)}&saveDir=${encodeURIComponent(downloadLocation)}`;

            // Hide form, show loading
            document.getElementById('download-modal').classList.remove('show');
            document.getElementById('preloader-modal').classList.add('show');

            // Record time when download starts
            modalShowTime = Date.now();

            // Make the request using htmx
            htmx.ajax('GET', downloadUrl, {
                target: '#download-result-container',
                swap: 'innerHTML'
            });
        }
    });

    // Handle cancel
    document.getElementById('cancel-download').addEventListener('click', function () {
        document.getElementById('download-modal').classList.remove('show');
        pendingDownload = null;
    });

    // Listen for htmx after-swap events
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        // Scroll to search results
        if (evt.detail.target.id === 'search-results-container') {
            const resultsContainer = document.getElementById('search-results-container');
            if (resultsContainer && resultsContainer.innerHTML.trim() !== '') {
                resultsContainer.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            }
        }

        // Hide modal after download completes
        if (evt.detail.target.id === 'download-result-container' && modalShowTime > 0) {
            const elapsedTime = Date.now() - modalShowTime;
            const remainingTime = Math.max(0, 1500 - elapsedTime);

            setTimeout(function () {
                document.getElementById('preloader-modal').classList.remove('show');
                pendingDownload = null;
                modalShowTime = 0;
            }, remainingTime);
        }
    });

    // Wishlist modal handling
    document.getElementById('wishlist-btn').addEventListener('click', function() {
        loadWishlist();
    });

    function loadWishlist() {
        fetch('/get-wishlist')
            .then(response => response.json())
            .then(data => {
                const wishlistContent = document.getElementById('wishlist-content');

                if (data.length === 0) {
                    wishlistContent.innerHTML = '<div class="wishlist-empty">No items in wishlist</div>';
                } else {
                    let tableHtml = `
                    <table class="wishlist-table">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Quality</th>
                                <th>Date Added</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                    data.forEach((item, index) => {
                        tableHtml += `
                        <tr>
                            <td class="wishlist-type">${item.type === 'm' ? '🎬 Movie' : '📺 Series'}</td>
                            <td class="wishlist-name">${item.name.replace(/\./g, ' ')}</td>
                            <td class="wishlist-quality">${item.quality}p</td>
                            <td class="wishlist-date">${item.dateAdded}</td>
                            <td class="wishlist-action">
                                <button class="delete-wishlist-btn" data-index="${index}" data-name="${item.name}">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                    });

                    tableHtml += `
                        </tbody>
                    </table>
                `;

                    wishlistContent.innerHTML = tableHtml;

                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-wishlist-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const index = this.dataset.index;
                            const name = this.dataset.name;

                            if (confirm(`Delete "${name.replace(/\./g, ' ')}" from wishlist?`)) {
                                deleteWishlistItem(index);
                            }
                        });
                    });
                }

                document.getElementById('wishlist-modal').classList.add('show');
            })
            .catch(error => {
                document.getElementById('wishlist-content').innerHTML = '<div class="wishlist-error">Error loading wishlist</div>';
                document.getElementById('wishlist-modal').classList.add('show');
            });
    }

    function deleteWishlistItem(index) {
        fetch('/delete-wishlist-item', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ index: parseInt(index) })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the wishlist
                    loadWishlist();
                } else {
                    alert('Error deleting item from wishlist');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting item from wishlist');
            });
    }

    // Close wishlist modal
    document.querySelector('.close-wishlist-btn').addEventListener('click', function() {
        document.getElementById('wishlist-modal').classList.remove('show');
    });

    // Close modal when clicking outside
    document.getElementById('wishlist-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
        }
    });


</script>
</body>
</html>
